$ErrorActionPreference = "Stop"

$root   = "C:\ProgramData\GuardianFW"
$logDir = Join-Path $root "logs"
New-Item -ItemType Directory -Path $logDir -Force | Out-Null

$outFile = Join-Path $logDir "health-task.out"
$tmpOut  = Join-Path $logDir "health-child.stdout.txt"
$tmpErr  = Join-Path $logDir "health-child.stderr.txt"
$latest  = Join-Path $root "evidence\health\health-latest.json"
$child   = Join-Path $root "engine\health.ps1"

function Log([string]$s){
  try { $s | Add-Content -Encoding UTF8 -Path $outFile -ErrorAction Stop } catch {}
}

# optional transcript (best-effort)
try {
  $tlog = Join-Path $logDir ("run-health.transcript.{0}.txt" -f (Get-Date -Format yyyyMMdd-HHmmss))
  Start-Transcript -Path $tlog -Force | Out-Null
} catch {}

try {
  Log ("==== {0} START ====" -f (Get-Date -Format s))
  Log ("WHOAMI: {0}" -f (whoami))
  Log ("PSVersion: {0}" -f ($PSVersionTable.PSVersion.ToString()))
  Log ("RUN (child): {0}" -f $child)

  if(!(Test-Path $child)){ throw "Missing child script: $child" }

  Remove-Item -LiteralPath $tmpOut, $tmpErr -EA SilentlyContinue
  & powershell.exe -NoProfile -ExecutionPolicy Bypass -File $child 1>$tmpOut 2>$tmpErr
  $childExit = $LASTEXITCODE
  Log ("CHILD_EXITCODE: {0}" -f $childExit)

  if(Test-Path $latest){
    try {
      $hj = Get-Content $latest -Raw -Encoding UTF8 | ConvertFrom-Json
      Log ("LATEST_TIMESTAMP: {0}" -f $hj.timestamp)
      Log ("LATEST_OVERALL:   {0}" -f $hj.overall)
    } catch {
      Log ("LATEST_PARSE_ERROR: {0}" -f $_.Exception.Message)
    }

    Log "---- STDOUT ----"
    if(Test-Path $tmpOut){ try { Log (Get-Content $tmpOut -Raw -Encoding UTF8) } catch {} }

    Log "---- STDERR ----"
    if(Test-Path $tmpErr){ try { Log (Get-Content $tmpErr -Raw -Encoding UTF8) } catch {} }

    Log "---- HEALTH-LATEST.JSON ----"
    try { Log (Get-Content $latest -Raw -Encoding UTF8) } catch {}
  } else {
    Log "LATEST_FILE: (missing)"
  }

  $exit = 2
  try {
    if(Test-Path $latest){
      $ov = (Get-Content $latest -Raw -Encoding UTF8 | ConvertFrom-Json).overall
      if($ov -eq "OK"){ $exit = 0 }
      elseif($ov -eq "DRIFT"){ $exit = 1 }
      else { $exit = 2 }
    }
  } catch { $exit = 2 }
# ---- Decision correlation (best-effort) ----
try {
  $decDir = Join-Path $root "evidence\decisions"
  if(Test-Path $decDir){
    $lastDec = Get-ChildItem $decDir -Filter "decision-*.json" -ErrorAction SilentlyContinue |
      Sort-Object LastWriteTime -Descending | Select-Object -First 1
    if($lastDec){
      $dj = Get-Content $lastDec.FullName -Raw -ErrorAction SilentlyContinue | ConvertFrom-Json

      # only log if decision timestamp is within last 10 minutes (best-effort)
      $ok = $true
      try {
        if($dj.timestamp){
          $dt = [datetime]::Parse($dj.timestamp)
          if($dt -lt (Get-Date).AddMinutes(-10)) { $ok = $false }
        }
      } catch {}

      if($ok){
        Log ("LAST_DECISION_FILE: {0}" -f $lastDec.Name)
        if($dj.timestamp){   Log ("LAST_DECISION_TS:    {0}" -f $dj.timestamp) }
        if($dj.intent_id){   Log ("LAST_DECISION_INTENT:{0}" -f $dj.intent_id) }
        if($dj.decision_id){ Log ("LAST_DECISION_ID:    {0}" -f $dj.decision_id) }
        if($dj.out_file){    Log ("LAST_DECISION_OUT:   {0}" -f $dj.out_file) }
      } else {
        Log "LAST_DECISION_NOTE: newest decision is older than 10 minutes"
      }
    } else {
      Log "LAST_DECISION_FILE: (none found)"
    }
  } else {
    Log "LAST_DECISION_DIR: (missing)"
  }
} catch {
  Log ("LAST_DECISION_ERROR: {0}" -f $ErrorActionPreference = "Stop"

$root   = "C:\ProgramData\GuardianFW"
$logDir = Join-Path $root "logs"
New-Item -ItemType Directory -Path $logDir -Force | Out-Null

$outFile = Join-Path $logDir "health-task.out"
$tmpOut  = Join-Path $logDir "health-child.stdout.txt"
$tmpErr  = Join-Path $logDir "health-child.stderr.txt"
$latest  = Join-Path $root "evidence\health\health-latest.json"
$child   = Join-Path $root "engine\health.ps1"

function Log([string]$s){
  try { $s | Add-Content -Encoding UTF8 -Path $outFile -ErrorAction Stop } catch {}
}

# optional transcript (best-effort)
try {
  $tlog = Join-Path $logDir ("run-health.transcript.{0}.txt" -f (Get-Date -Format yyyyMMdd-HHmmss))
  Start-Transcript -Path $tlog -Force | Out-Null
} catch {}

try {
  Log ("==== {0} START ====" -f (Get-Date -Format s))
  Log ("WHOAMI: {0}" -f (whoami))
  Log ("PSVersion: {0}" -f ($PSVersionTable.PSVersion.ToString()))
  Log ("RUN (child): {0}" -f $child)

  if(!(Test-Path $child)){ throw "Missing child script: $child" }

  Remove-Item -LiteralPath $tmpOut, $tmpErr -EA SilentlyContinue
  & powershell.exe -NoProfile -ExecutionPolicy Bypass -File $child 1>$tmpOut 2>$tmpErr
  $childExit = $LASTEXITCODE
  Log ("CHILD_EXITCODE: {0}" -f $childExit)

  if(Test-Path $latest){
    try {
      $hj = Get-Content $latest -Raw -Encoding UTF8 | ConvertFrom-Json
      Log ("LATEST_TIMESTAMP: {0}" -f $hj.timestamp)
      Log ("LATEST_OVERALL:   {0}" -f $hj.overall)
    } catch {
      Log ("LATEST_PARSE_ERROR: {0}" -f $_.Exception.Message)
    }

    Log "---- STDOUT ----"
    if(Test-Path $tmpOut){ try { Log (Get-Content $tmpOut -Raw -Encoding UTF8) } catch {} }

    Log "---- STDERR ----"
    if(Test-Path $tmpErr){ try { Log (Get-Content $tmpErr -Raw -Encoding UTF8) } catch {} }

    Log "---- HEALTH-LATEST.JSON ----"
    try { Log (Get-Content $latest -Raw -Encoding UTF8) } catch {}
  } else {
    Log "LATEST_FILE: (missing)"
  }

  $exit = 2
  try {
    if(Test-Path $latest){
      $ov = (Get-Content $latest -Raw -Encoding UTF8 | ConvertFrom-Json).overall
      if($ov -eq "OK"){ $exit = 0 }
      elseif($ov -eq "DRIFT"){ $exit = 1 }
      else { $exit = 2 }
    }
  } catch { $exit = 2 }

  Log ("WRAPPER_RETURNING: {0}" -f $exit)
  Log ("==== {0} END ====" -f (Get-Date -Format s))
  exit $exit
}
catch {
  Log ("WRAPPER_ERROR: {0}" -f $_.Exception.Message)
  try { Log ("AT: {0}" -f $_.InvocationInfo.PositionMessage) } catch {}
  Log ("WRAPPER_RETURNING: 2")
  Log ("==== {0} END ====" -f (Get-Date -Format s))
  exit 2
}
finally {
  try { Stop-Transcript | Out-Null } catch {}
}.Exception.Message)
}
# ---- End decision correlation ----

  Log ("WRAPPER_RETURNING: {0}" -f $exit)
  Log ("==== {0} END ====" -f (Get-Date -Format s))
  exit $exit
}
catch {
  Log ("WRAPPER_ERROR: {0}" -f $_.Exception.Message)
  try { Log ("AT: {0}" -f $_.InvocationInfo.PositionMessage) } catch {}
# ---- Decision correlation (best-effort) ----
try {
  $decDir = Join-Path $root "evidence\decisions"
  if(Test-Path $decDir){
    $lastDec = Get-ChildItem $decDir -Filter "decision-*.json" -ErrorAction SilentlyContinue |
      Sort-Object LastWriteTime -Descending | Select-Object -First 1
    if($lastDec){
      $dj = Get-Content $lastDec.FullName -Raw -ErrorAction SilentlyContinue | ConvertFrom-Json

      # only log if decision timestamp is within last 10 minutes (best-effort)
      $ok = $true
      try {
        if($dj.timestamp){
          $dt = [datetime]::Parse($dj.timestamp)
          if($dt -lt (Get-Date).AddMinutes(-10)) { $ok = $false }
        }
      } catch {}

      if($ok){
        Log ("LAST_DECISION_FILE: {0}" -f $lastDec.Name)
        if($dj.timestamp){   Log ("LAST_DECISION_TS:    {0}" -f $dj.timestamp) }
        if($dj.intent_id){   Log ("LAST_DECISION_INTENT:{0}" -f $dj.intent_id) }
        if($dj.decision_id){ Log ("LAST_DECISION_ID:    {0}" -f $dj.decision_id) }
        if($dj.out_file){    Log ("LAST_DECISION_OUT:   {0}" -f $dj.out_file) }
      } else {
        Log "LAST_DECISION_NOTE: newest decision is older than 10 minutes"
      }
    } else {
      Log "LAST_DECISION_FILE: (none found)"
    }
  } else {
    Log "LAST_DECISION_DIR: (missing)"
  }
} catch {
  Log ("LAST_DECISION_ERROR: {0}" -f $ErrorActionPreference = "Stop"

$root   = "C:\ProgramData\GuardianFW"
$logDir = Join-Path $root "logs"
New-Item -ItemType Directory -Path $logDir -Force | Out-Null

$outFile = Join-Path $logDir "health-task.out"
$tmpOut  = Join-Path $logDir "health-child.stdout.txt"
$tmpErr  = Join-Path $logDir "health-child.stderr.txt"
$latest  = Join-Path $root "evidence\health\health-latest.json"
$child   = Join-Path $root "engine\health.ps1"

function Log([string]$s){
  try { $s | Add-Content -Encoding UTF8 -Path $outFile -ErrorAction Stop } catch {}
}

# optional transcript (best-effort)
try {
  $tlog = Join-Path $logDir ("run-health.transcript.{0}.txt" -f (Get-Date -Format yyyyMMdd-HHmmss))
  Start-Transcript -Path $tlog -Force | Out-Null
} catch {}

try {
  Log ("==== {0} START ====" -f (Get-Date -Format s))
  Log ("WHOAMI: {0}" -f (whoami))
  Log ("PSVersion: {0}" -f ($PSVersionTable.PSVersion.ToString()))
  Log ("RUN (child): {0}" -f $child)

  if(!(Test-Path $child)){ throw "Missing child script: $child" }

  Remove-Item -LiteralPath $tmpOut, $tmpErr -EA SilentlyContinue
  & powershell.exe -NoProfile -ExecutionPolicy Bypass -File $child 1>$tmpOut 2>$tmpErr
  $childExit = $LASTEXITCODE
  Log ("CHILD_EXITCODE: {0}" -f $childExit)

  if(Test-Path $latest){
    try {
      $hj = Get-Content $latest -Raw -Encoding UTF8 | ConvertFrom-Json
      Log ("LATEST_TIMESTAMP: {0}" -f $hj.timestamp)
      Log ("LATEST_OVERALL:   {0}" -f $hj.overall)
    } catch {
      Log ("LATEST_PARSE_ERROR: {0}" -f $_.Exception.Message)
    }

    Log "---- STDOUT ----"
    if(Test-Path $tmpOut){ try { Log (Get-Content $tmpOut -Raw -Encoding UTF8) } catch {} }

    Log "---- STDERR ----"
    if(Test-Path $tmpErr){ try { Log (Get-Content $tmpErr -Raw -Encoding UTF8) } catch {} }

    Log "---- HEALTH-LATEST.JSON ----"
    try { Log (Get-Content $latest -Raw -Encoding UTF8) } catch {}
  } else {
    Log "LATEST_FILE: (missing)"
  }

  $exit = 2
  try {
    if(Test-Path $latest){
      $ov = (Get-Content $latest -Raw -Encoding UTF8 | ConvertFrom-Json).overall
      if($ov -eq "OK"){ $exit = 0 }
      elseif($ov -eq "DRIFT"){ $exit = 1 }
      else { $exit = 2 }
    }
  } catch { $exit = 2 }

  Log ("WRAPPER_RETURNING: {0}" -f $exit)
  Log ("==== {0} END ====" -f (Get-Date -Format s))
  exit $exit
}
catch {
  Log ("WRAPPER_ERROR: {0}" -f $_.Exception.Message)
  try { Log ("AT: {0}" -f $_.InvocationInfo.PositionMessage) } catch {}
  Log ("WRAPPER_RETURNING: 2")
  Log ("==== {0} END ====" -f (Get-Date -Format s))
  exit 2
}
finally {
  try { Stop-Transcript | Out-Null } catch {}
}.Exception.Message)
}
# ---- End decision correlation ----
  Log ("WRAPPER_RETURNING: 2")
  Log ("==== {0} END ====" -f (Get-Date -Format s))
  exit 2
}
finally {
  try { Stop-Transcript | Out-Null } catch {}
}
