param(
  [Parameter(Mandatory=$true)][string]$IntentId,
  [string]$Decision = "BLOCK",
  [string]$ProcessName = "",
  [string]$ProcessPath = "",
  [string]$UserName = "",
  [string]$Protocol = "",
  [int]$RemotePort = 0,
  [string]$Destination = "",
  [string]$EnforcementRule = "",
  [Parameter()][string[]]$Justification = @(),
)
)

# --- Normalize + validate Justification ---
$Justification = @($Justification | ForEach-Object { "$_".Trim() } | Where-Object { $_ })
if($Justification.Count -lt 1){ throw "Justification must contain at least 1 item." }
if($Justification.Count -gt 10){ $Justification = $Justification[0..9] }

$ErrorActionPreference="Stop"


# Normalize Justification to string[] always
$Justification = @(
  foreach($x in @($Justification)){
    $t = (""+$x).Trim()
    if($t){ $t }
  }
)
if ($null -eq $Justification) { $Justification = @() }
$Justification = @($Justification | ForEach-Object { [string]$_ })

$root="C:\ProgramData\GuardianFW"
$intentPath="$root\policies\intent-map.json"
$evDir="$root\evidence\decisions"
New-Item -ItemType Directory -Path $evDir -Force | Out-Null

$intent = $null
try {
  $imap = Get-Content $intentPath -Raw | ConvertFrom-Json
  $intent = $imap.intents | Where-Object { $_.id -eq $IntentId } | Select-Object -First 1
} catch {}

$repeat = 0
$risk = & "$root\engine\risk-score.ps1" -IntentId $IntentId -ProcessPath $ProcessPath -RepeatCount $repeat
# ---- Force Justification to string[] (robust) ----
if ($null -eq $Justification) { $Justification = @() }

# Ensure array first
$Justification = @($Justification)

# If it came in as a single comma-joined string (very common), split it
if ($Justification.Count -eq 1) {
  $one = [string]$Justification[0]
  if ($one -match ',') {
    $Justification = @($one -split '\s*,\s*')
  }
}

# Trim + drop empties
$Justification = @(
  foreach($x in $Justification){
    $v = (""+$x).Trim()
    if($v){ $v }
  }
)
# -----------------------------------------------

# --------------------------------

$rec = @{
timestamp = (Get-Date).ToString("s")
  decision  = $Decision
  intent_id = $IntentId
  intent_category = if($intent){[string]$intent.category}else{""}
  severity  = if($intent){[string]$intent.severity}else{""}
  risk_score = [int]$risk
  confidence = "HIGH"
  subject = @{ process=$ProcessName; path=$ProcessPath; user=$UserName }
  network = @{ protocol=$Protocol; remote_port=$RemotePort; destination=$Destination }
  enforcement = @{ method="WFP + Firewall"; rule=$EnforcementRule }
  justification = $Justification
}

$fn = "decision-{0}.json" -f (Get-Date -Format "yyyyMMdd-HHmmss")
$outPath = Join-Path $dir $fn
$rec | ConvertTo-Json -Depth 10 | Out-File (Join-Path $evDir $fn) -Encoding UTF8
$rec



