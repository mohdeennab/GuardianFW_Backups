param([switch]$SelfTest)

$ErrorActionPreference="SilentlyContinue"

# GuardianFW Detect-DoH (ETW)
# Exit: 0=clean, 20=suspicious (TCP connect to known DoH resolver IP on 443)

$dohIps = @("1.1.1.1","1.0.0.1","8.8.8.8","8.8.4.4","9.9.9.9","149.112.112.112")

$eventsDir = "C:\ProgramData\GuardianFW\events"
New-Item -ItemType Directory -Path $eventsDir -Force | Out-Null
$logPath = Join-Path $eventsDir "doh-detect.jsonl"

$etl = Join-Path $eventsDir "tcpip_doh.etl"
$txt = Join-Path $eventsDir "tcpip_doh.txt"

function Stop-TraceQuiet { try { netsh trace stop | Out-Null } catch {} }

Stop-TraceQuiet
try {
  try { Remove-Item $etl,$txt -Force -EA SilentlyContinue | Out-Null } catch {}

  netsh trace start capture=no report=no tracefile="$etl" provider=Microsoft-Windows-TCPIP level=5 keywords=0xFFFFFFFF | Out-Null

  if($SelfTest){
    Start-Sleep -Milliseconds 200
    $u="https://cloudflare-dns.com/dns-query?name=example.com&type=A"
    curl.exe -s --http1.1 "$u" --resolve cloudflare-dns.com:443:1.1.1.1 -H "accept: application/dns-json" | Out-Null
  }

  Start-Sleep -Seconds 2
}
finally {
  Stop-TraceQuiet
}

netsh trace convert input="$etl" output="$txt" | Out-Null

# Read whole file so regex survives line wrapping
$blob = ""
try { $blob = Get-Content -LiteralPath $txt -Raw -EA SilentlyContinue } catch {}
if(-not $blob){ try { Remove-Item $etl,$txt -Force -EA SilentlyContinue | Out-Null } catch {}; exit 0 }

# Regex: find "remote=IP:443 ... connect completed ... PID = N"
$re = [regex]'(?is)remote=(\d{1,3}(?:\.\d{1,3}){3}):443\)\s*connect\s+completed\.\s*PID\s*=\s*(\d+)'
$ms = $re.Matches($blob)

$hits = @()
foreach($m in $ms){
  $rip = $m.Groups[1].Value
  if($dohIps -notcontains $rip){ continue }
  $pid = [int]$m.Groups[2].Value

  $proc="unknown"
  try { $p = Get-Process -Id $pid -EA SilentlyContinue; if($p){ $proc = $p.ProcessName } } catch {}

  $hits += [pscustomobject]@{
    ts     = (Get-Date).ToString("s")
    remote = $rip
    port   = 443
    pid    = $pid
    proc   = $proc
    source = "etw_tcpip_connect_completed"
  }
}

try { Remove-Item $etl,$txt -Force -EA SilentlyContinue | Out-Null } catch {}

if($hits.Count -gt 0){
  $hits | ForEach-Object { ($_ | ConvertTo-Json -Compress) } | Add-Content -LiteralPath $logPath -Encoding UTF8
  exit 20
}

exit 0
