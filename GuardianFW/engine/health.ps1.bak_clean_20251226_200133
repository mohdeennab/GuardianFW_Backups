$ErrorActionPreference="Stop"
$root="C:\ProgramData\GuardianFW"

$traceDir = Join-Path $root "logs"
# --- Single instance lock (prevents overlapping scheduled runs) ---
$lock = Join-Path $traceDir "health.lock"
if(Test-Path $lock){
  Trace "LOCKED: previous run still active. Exiting."
  exit 0
}
"locked $(Get-Date -Format s) pid=$PID" | Set-Content -Encoding UTF8 $lock
New-Item -ItemType Directory -Path $traceDir -Force | Out-Null
$trace = Join-Path $traceDir "health-steps.txt"

function Trace([string]$msg){
  ("[{0}] {1}" -f (Get-Date -Format s), $msg) | Add-Content -Encoding UTF8 $trace
}

function Run-Step([string]$name, [string]$scriptPath, [int]$timeoutSec=15){
  Trace ("STEP_START {0} -> {1}" -f $name, $scriptPath)
  $t0 = Get-Date

  $ps = "$env:WINDIR\System32\WindowsPowerShell\v1.0\powershell.exe"
  $tmpOut = Join-Path $traceDir ("step-{0}.out.txt" -f $name)
  $tmpErr = Join-Path $traceDir ("step-{0}.err.txt" -f $name)
  Remove-Item -Force $tmpOut,$tmpErr -ErrorAction SilentlyContinue

  $p = Start-Process -FilePath $ps -ArgumentList @(
      "-NoProfile","-ExecutionPolicy","Bypass","-File",$scriptPath
    ) -PassThru -WindowStyle Hidden `
    -RedirectStandardOutput $tmpOut `
    -RedirectStandardError  $tmpErr

  $pid = $p.Id
  Trace ("STEP_PID {0} pid={1}" -f $name, $pid)

  # Wait, then refresh process state
  $null = $p.WaitForExit($timeoutSec * 1000)
  try { $p.Refresh() } catch {}

  $sec = [int]((Get-Date)-$t0).TotalSeconds

  if(-not $p.HasExited){
    Trace ("STEP_TIMEOUT {0} after {1}s (PID={2})" -f $name,$timeoutSec,$pid)
    try { Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue } catch {}
    return @{ status="TIMEOUT"; name=$name; pid=$pid; seconds=$sec; out=$tmpOut; err=$tmpErr }
  }

  Trace ("STEP_END {0} exit={1} sec={2}" -f $name,$p.ExitCode,$sec)
  return @{ status="OK"; name=$name; pid=$pid; exitcode=$p.ExitCode; seconds=$sec; out=$tmpOut; err=$tmpErr }
}

Trace "HEALTH_START"

$fwStep  = Run-Step -name "firewall"  -scriptPath (Join-Path $root "engine\verify-firewall.ps1")  -timeoutSec 20
$regStep = Run-Step -name "registry"  -scriptPath (Join-Path $root "engine\verify-registry.ps1")  -timeoutSec 20
$intStep = Run-Step -name "integrity" -scriptPath (Join-Path $root "engine\verify-integrity.ps1") -timeoutSec 20

# Main snapshot (in-proc; should be fast now)
$fw  = & "$root\engine\verify-firewall.ps1"
$reg = & "$root\engine\verify-registry.ps1"
$int = & "$root\engine\verify-integrity.ps1"

$overall = if($fw.status -eq "OK" -and $reg.status -eq "OK" -and $int.status -eq "OK"){"OK"}else{"DRIFT"}

$out = @{
  timestamp=(Get-Date).ToString("s")
  overall=$overall
  firewall=$fw
  registry=$reg
  integrity=$int
  steps=@{ firewall=$fwStep; registry=$regStep; integrity=$intStep }
}

$evDir="$root\evidence\health"
New-Item -ItemType Directory -Path $evDir -Force | Out-Null

$fn = "health-{0}.json" -f (Get-Date -Format yyyyMMdd-HHmmss)
$out | ConvertTo-Json -Depth 12 | Out-File (Join-Path $evDir $fn) -Encoding UTF8
$out | ConvertTo-Json -Depth 12 | Out-File (Join-Path $evDir "health-latest.json") -Encoding UTF8

Trace ("HEALTH_END overall={0}" -f $overall)
$out
exit 0



# --- best-effort unlock ---
try { Remove-Item  -Force -ErrorAction SilentlyContinue } catch {}

