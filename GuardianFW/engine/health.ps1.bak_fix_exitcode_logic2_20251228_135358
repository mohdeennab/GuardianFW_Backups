# health.ps1 (Phase3) - exitcode-based aggregator
# Exit codes: 0=OK, 20=DRIFT, 50=ERROR
$ErrorActionPreference="Stop"
Set-StrictMode -Version Latest

$root="C:\ProgramData\GuardianFW"
$engine=Join-Path $root "engine"

function RunProbe([string]$name){
  $path = Join-Path $engine $name
  if(!(Test-Path -LiteralPath $path)){
    return @{ name=$name; status="MISSING"; exit=0 }
  }
  & powershell.exe -NoProfile -ExecutionPolicy Bypass -File $path 1>$null 2>$null
  $code = [int]$LASTEXITCODE
  $st = if($code -eq 0){"OK"} elseif($code -eq 20){"DRIFT"} else {"ERROR"}
  return @{ name=$name; status=$st; exit=$code }
}

$fw  = RunProbe "verify-firewall.ps1"
$reg = RunProbe "verify-registry.ps1"
$int = RunProbe "verify-integrity.ps1"

# overall health: ERROR > DRIFT > OK
$exit = 0
if($fw.exit -ge 50 -or $reg.exit -ge 50 -or $int.exit -ge 50){
  $exit = 50
} elseif($fw.exit -eq 20 -or $reg.exit -eq 20 -or $int.exit -eq 20){
  $exit = 20
}

"HEALTH: {0}  (firewall={1}, registry={2}, integrity={3})" -f `
  (if($exit -eq 0){"OK"}elseif($exit -eq 20){"DRIFT"}else{"ERROR"}), `
  $fw.status, $reg.status, $int.status

exit $exit
