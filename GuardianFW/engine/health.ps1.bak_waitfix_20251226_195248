$ErrorActionPreference="Stop"
$root="C:\ProgramData\GuardianFW"

$traceDir = Join-Path $root "logs"
New-Item -ItemType Directory -Path $traceDir -Force | Out-Null
$trace = Join-Path $traceDir "health-steps.txt"

function Trace([string]$msg){
  ("[{0}] {1}" -f (Get-Date -Format s), $msg) | Add-Content -Encoding UTF8 $trace
}

function Run-Step([string]$name, [string]$scriptPath, [int]$timeoutSec=10){
  Trace ("STEP_START {0} -> {1}" -f $name, $scriptPath)
  $t0 = Get-Date

  # run step in its own powershell so a hang is isolatable
  $ps = "$env:WINDIR\System32\WindowsPowerShell\v1.0\powershell.exe"
  $tmpOut = Join-Path $traceDir ("step-{0}.out.txt" -f $name)
  $tmpErr = Join-Path $traceDir ("step-{0}.err.txt" -f $name)
  Remove-Item -Force $tmpOut,$tmpErr -ErrorAction SilentlyContinue

  $p = Start-Process -FilePath $ps -ArgumentList @(
      "-NoProfile","-ExecutionPolicy","Bypass","-File",$scriptPath
    ) -PassThru -WindowStyle Hidden `
    -RedirectStandardOutput $tmpOut `
    -RedirectStandardError  $tmpErr

  $ok = Wait-Process -Id $p.Id -Timeout $timeoutSec -ErrorAction SilentlyContinue
  if(-not $ok){
    Trace ("STEP_TIMEOUT {0} after {1}s (PID={2})" -f $name,$timeoutSec,$p.Id)
    try { Stop-Process -Id $p.Id -Force -ErrorAction SilentlyContinue } catch {}
    return @{ status="TIMEOUT"; name=$name; seconds=[int]((Get-Date)-$t0).TotalSeconds; out=$tmpOut; err=$tmpErr }
  }

  $sec = [int]((Get-Date)-$t0).TotalSeconds
  Trace ("STEP_END {0} exit={1} sec={2}" -f $name,$p.ExitCode,$sec)

  # try to parse JSON-ish output: we keep it simple: just return exitcode + files
  return @{ status="OK"; name=$name; exitcode=$p.ExitCode; seconds=$sec; out=$tmpOut; err=$tmpErr }
}

Trace "HEALTH_START"

$fwStep  = Run-Step -name "firewall"  -scriptPath (Join-Path $root "engine\verify-firewall.ps1")  -timeoutSec 15
$regStep = Run-Step -name "registry"  -scriptPath (Join-Path $root "engine\verify-registry.ps1")  -timeoutSec 15
$intStep = Run-Step -name "integrity" -scriptPath (Join-Path $root "engine\verify-integrity.ps1") -timeoutSec 15

# still run original logic inside this process (fast) for the JSON snapshot
$fw  = & "$root\engine\verify-firewall.ps1"
$reg = & "$root\engine\verify-registry.ps1"
$int = & "$root\engine\verify-integrity.ps1"

$overall = if($fw.status -eq "OK" -and $reg.status -eq "OK" -and $int.status -eq "OK"){"OK"}else{"DRIFT"}

$out = @{
  timestamp=(Get-Date).ToString("s")
  overall=$overall
  firewall=$fw
  registry=$reg
  integrity=$int
  steps=@{ firewall=$fwStep; registry=$regStep; integrity=$intStep }
}

$evDir="$root\evidence\health"
New-Item -ItemType Directory -Path $evDir -Force | Out-Null

$fn = "health-{0}.json" -f (Get-Date -Format yyyyMMdd-HHmmss)
$out | ConvertTo-Json -Depth 12 | Out-File (Join-Path $evDir $fn) -Encoding UTF8
$out | ConvertTo-Json -Depth 12 | Out-File (Join-Path $evDir "health-latest.json") -Encoding UTF8

Trace ("HEALTH_END overall={0}" -f $overall)
$out
exit 0
