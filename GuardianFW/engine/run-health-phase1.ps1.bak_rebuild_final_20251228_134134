# run-health-phase1.ps1
# GuardianFW  Phase 1 Health Wrapper (CLEAN REBUILD)
# Goal: Always parse + always log + return meaningful exit code.
# This wrapper can call other probe scripts that may exist in engine\.

$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

$Root = "C:\ProgramData\GuardianFW"
$Log  = Join-Path $Root "logs\health-task.out"
$EngineDir = Join-Path $Root "engine"

function Ensure-Dir([string]$p){
  if(!(Test-Path -LiteralPath $p)){
    New-Item -ItemType Directory -Path $p -Force | Out-Null
  }
}

Ensure-Dir (Split-Path -Parent $Log)

function Out-Task([string]$msg){
  Add-ContentWithRetry -Path $Log -Value $msg
}

function Stamp([string]$label){
  $ts = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss.ff")
  Out-Task ("==== {0} {1} (task) ====" -f $ts, $label)
}

function Safe([scriptblock]$sb){
  try { & $sb } catch { return $_ }
  return $null
}

# ---- Start logging block (matches your scheduled task expectations) ----
Stamp "START"
Out-Task ([Environment]::UserName)
Out-Task ("PWD={0}" -f (Get-Location).Path)
Out-Task ("PS={0}" -f $PSHOME + "\powershell.exe")
$psExe = Join-Path $PSHOME "powershell.exe"
$psExists = if(Test-Path -LiteralPath $psExe){"YES"} else {"NO"}
Out-Task ("PS_EXISTS={0}" -f $psExists)
Out-Task "BEFORE_POWERSHELL"

# ---- Phase 1 checks (call existing probe scripts if present) ----
# Convention: each probe returns exit code 0 for OK, non-zero for FAIL.
# If a probe file doesn't exist, we log a WARN but do not fail Phase 1.

$probes = @(
  "Detect-FWDisabled.ps1",
  "verify-integrity.ps1"
)

$overallExit = 0
$failures = New-Object 'System.Collections.Generic.List[string]'

foreach($p in $probes){
  $probePath = Join-Path $EngineDir $p
  if(!(Test-Path -LiteralPath $probePath)){
    Out-Task ("[WARN] Missing probe: {0}" -f $probePath)
    continue
  }

  $err = Safe { & powershell.exe -NoProfile -ExecutionPolicy Bypass -File $probePath }
  $code = $LASTEXITCODE

  if($err -ne $null){
    $overallExit = 50
    $failures.Add(("Probe exception: {0} :: {1}" -f $p, (ErrText $err))) | Out-Null
    Out-Task ("[[TASKTRACE_ERROR]] Probe exception in {0}: {1}" -f $p, (ErrText $err))
    continue
  }

  Out-Task ("Probe {0} exit={1}" -f $p, $code)

  if($code -ne 0){
    if($overallExit -eq 0){ $overallExit = $code }
    $failures.Add(("Probe failed: {0} exit={1}" -f $p, $code)) | Out-Null
  }
}

# ---- tiny health summary line ----
if($overallExit -eq 0){
  Out-Task "[GFW] health=OK"
} else {
  Out-Task ("[GFW] health=ERROR exit={0}" -f $overallExit)
  foreach($f in $failures){ Out-Task ("[GFW] " + $f) }
}

Out-Task "[[TASKTRACE_LASTEXIT]]"
Out-Task "AFTER_POWERSHELL"
Stamp "END"

exit $overallExit





