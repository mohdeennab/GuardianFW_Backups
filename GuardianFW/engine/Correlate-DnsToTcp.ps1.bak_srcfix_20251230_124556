Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

$script:GuardianRoot = "C:\ProgramData\GuardianFW"
$script:DnsCachePath = Join-Path $script:GuardianRoot "cache\dns-ip-index.ndjson"
$script:DnsRawPath   = Join-Path $script:GuardianRoot "logs\guardian-audit.jsonl"
$script:MutexName    = "Global\GuardianFW_DnsCache_Mutex"
$script:LookbackMs   = 7000
$script:MaxCandidates = 30

function Get-UtcNowIso { (Get-Date).ToUniversalTime().ToString("o") }

function Try-ParseTimeToEpochMs {
  param([Parameter(Mandatory)] $ts)
  try {
    if ($ts -is [int] -or $ts -is [long] -or ($ts -is [string] -and $ts -match '^\d{10,16}$')) {
      return [int64]$ts
    }
    $dt = [DateTime]::Parse($ts, [Globalization.CultureInfo]::InvariantCulture, [Globalization.DateTimeStyles]::AssumeUniversal)
    return [int64](New-TimeSpan -Start ([DateTime]'1970-01-01Z') -End $dt.ToUniversalTime()).TotalMilliseconds
  } catch { return $null }
}

function With-Mutex {
  param(
    [Parameter(Mandatory)][string]$Name,
    [Parameter(Mandatory)][scriptblock]$Body,
    [int]$TimeoutMs = 1500
  )
  $m = New-Object System.Threading.Mutex($false, $Name)
  $acquired = $false
  try {
    $acquired = $m.WaitOne($TimeoutMs)
    if (-not $acquired) { throw "Mutex timeout: $Name" }
    & $Body
  } finally {
    if ($acquired) { $m.ReleaseMutex() | Out-Null }
    $m.Dispose()
  }
}

function Read-NdjsonTail {
  param([Parameter(Mandatory)][string]$Path,[int]$MaxLines = 8000)
  if (!(Test-Path -LiteralPath $Path)) { return @() }
  try { Get-Content -LiteralPath $Path -Encoding UTF8 -Tail $MaxLines -ErrorAction Stop }
  catch { @() }
}

function Normalize-DnsRecord {
  param([Parameter(Mandatory)] $obj)

  $ts = $obj.ts; if ($null -eq $ts) { $ts = $obj.tsUtc }; if ($null -eq $ts) { $ts = $obj.timestamp }; if ($null -eq $ts) { $ts = $obj.time }
  $ip = $obj.ip; if ($null -eq $ip) { $ip = $obj.answer_ip }; if ($null -eq $ip) { $ip = $obj.resolved_ip }
  $domain = $obj.domain; if ($null -eq $domain) { $domain = $obj.qname }; if ($null -eq $domain) { $domain = $obj.host }
  $ProcPid = $obj.pid; if ($null -eq $ProcPid) { $ProcPid = $obj.process_pid }
  $proc = $obj.proc; if ($null -eq $proc) { $proc = $obj.process }; if ($null -eq $proc) { $proc = $obj.process_name }
  $resolver = $obj.resolver; if ($null -eq $resolver) { $resolver = $obj.dns_server }
  $qtype = $obj.qtype; if ($null -eq $qtype) { $qtype = $obj.type }

  [pscustomobject]@{
    ts       = $ts
    epoch_ms = (Try-ParseTimeToEpochMs $ts)
    ip       = $ip
    domain   = $domain
    pid      = $ProcPid
    proc     = $proc
    resolver = $resolver
    qtype    = $qtype
    _raw     = $obj
  }
}

function Get-RecentDnsByIP {
  param(
    [Parameter(Mandatory)][string]$DstIP,
    [Parameter(Mandatory)][int64]$NowEpochMs,
    [int64]$LookbackMs = $script:LookbackMs
  )
  $minEpoch = $NowEpochMs - $LookbackMs

  $readBlock = {
    $srcPath = if (Test-Path -LiteralPath $script:DnsCachePath) { $script:DnsCachePath } else { $script:DnsRawPath }
    $lines = Read-NdjsonTail -Path $srcPath -MaxLines 12000

    $hits = New-Object System.Collections.Generic.List[object]
    foreach ($ln in $lines) {
      if ([string]::IsNullOrWhiteSpace($ln)) { continue }
      $o=$null; try { $o = $ln | ConvertFrom-Json -ErrorAction Stop } catch { continue }

# Keep only DNS-like entries when scanning guardian-audit.jsonl (StrictMode-safe)
# Your schema uses: {"tsUtc": "...", "event": "...", "data": {...}}
$ev = $null
try { $ev = $o.event } catch { $ev = $null }
if ($null -ne $ev) {
  if ($ev -notmatch 'dns') { continue }
}


      $n = Normalize-DnsRecord $o
      if ($null -eq $n.epoch_ms) { continue }
      if ($n.epoch_ms -lt $minEpoch) { continue }
      if ($null -eq $n.ip -or $n.ip -ne $DstIP) { continue }
      if ([string]::IsNullOrWhiteSpace($n.domain)) { continue }
      $hits.Add($n) | Out-Null
      if ($hits.Count -ge $script:MaxCandidates) { break }
    }
    $hits | Sort-Object epoch_ms -Descending
  }

  With-Mutex -Name $script:MutexName -Body $readBlock
}

function Correlate-DnsToTcp {
  param(
    [Parameter(Mandatory)][string]$DstIP,
    [Parameter(Mandatory)][int]$DstPort,
    [int]$ProcPid,
    [string]$ProcName,
    [string]$Protocol = "TCP",
    [string]$SrcIP,
    [string]$EventTsUtcIso = (Get-UtcNowIso)
  )

  $nowMs = Try-ParseTimeToEpochMs $EventTsUtcIso
  if ($null -eq $nowMs) {
    $nowMs = [int64](New-TimeSpan -Start ([DateTime]'1970-01-01Z') -End (Get-Date).ToUniversalTime()).TotalMilliseconds
  }

  $cands = @(Get-RecentDnsByIP -DstIP $DstIP -NowEpochMs $nowMs)
  if ($null -eq $cands -or $cands.Count -eq 0) {
    return [pscustomobject]@{
      match_type="None"; confidence=0.10; reason="no_recent_dns_for_ip"; dns=$null
      window_ms=$script:LookbackMs; dst_ip=$DstIP; dst_port=$DstPort; pid=$ProcPid; proc=$ProcName; protocol=$Protocol; ts=$EventTsUtcIso
    }
  }

  $strong=$null
  if ($ProcPid -and $ProcPid -gt 0) { $strong = $cands | Where-Object { $_.pid -and ([int]$_.pid -eq $ProcPid) } | Select-Object -First 1 }

  if ($null -ne $strong) {
    $age = $nowMs - $strong.epoch_ms
    $conf = 0.92; if ($age -gt 2500) { $conf = 0.86 }
    return [pscustomobject]@{
      match_type="Strong"; confidence=$conf; reason="ip_and_pid_and_time_window"
      dns=[pscustomobject]@{ domain=$strong.domain; resolver=$strong.resolver; qtype=$strong.qtype; resolution_age_ms=$age; source=$((if(Test-Path $script:DnsCachePath){"dns_ip_index"}else{"dns_cache_tail"})) }
      window_ms=$script:LookbackMs; dst_ip=$DstIP; dst_port=$DstPort; pid=$ProcPid; proc=$ProcName; protocol=$Protocol; ts=$EventTsUtcIso
    }
  }

  $weak = $cands | Select-Object -First 1
  $ageW = $nowMs - $weak.epoch_ms
  $confW = 0.62; if ($ageW -le 800) { $confW = 0.72 }; if ($ageW -gt 3000) { $confW = 0.55 }

  [pscustomobject]@{
    match_type="Weak"; confidence=$confW; reason="ip_and_time_window_only"
    dns=[pscustomobject]@{ domain=$weak.domain; resolver=$weak.resolver; qtype=$weak.qtype; resolution_age_ms=$ageW; source=$((if(Test-Path $script:DnsCachePath){"dns_ip_index"}else{"dns_cache_tail"})) }
    window_ms=$script:LookbackMs; dst_ip=$DstIP; dst_port=$DstPort; pid=$ProcPid; proc=$ProcName; protocol=$Protocol; ts=$EventTsUtcIso
  }
}







