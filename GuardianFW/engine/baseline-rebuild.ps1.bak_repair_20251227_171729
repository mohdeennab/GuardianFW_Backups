# baseline-rebuild.ps1 (atomic)
# Writes to a temp file then atomically replaces baseline.sha256.
# Safe under scheduled task concurrency.

$ErrorActionPreference="Stop"
Set-StrictMode -Version Latest

$Root = "C:\ProgramData\GuardianFW"
$baselineDir = Join-Path $Root "baseline"
$baselineOut = Join-Path $baselineDir "baseline.sha256"
$tmp = Join-Path $baselineDir ("baseline.sha256.tmp_{0}" -f ([guid]::NewGuid().ToString("n")))

if(-not (Test-Path $baselineDir)){ New-Item -ItemType Directory -Path $baselineDir -Force | Out-Null }

$CoreFiles = @(
  (Join-Path $Root "config.json"),
  (Join-Path $Root "engine\run-health.ps1"),
  (Join-Path $Root "engine\run-health-phase1.ps1"),
  (Join-Path $Root "engine\Guardian.ExitCodes.psm1"),
  (Join-Path $Root "engine\Guardian.Evidence.psm1"),
  (Join-Path $Root "engine\Guardian.Config.psm1"),
  (Join-Path $Root "engine\Guardian.DB.psm1"),
  (Join-Path $Root "engine\Guardian.Map.psm1"),`r`n  (Join-Path $Root "engine\Enforce-DnsPolicy.ps1") )

"# GuardianFW baseline hashes (Phase1) - rebuilt $(Get-Date -Format s)" |
  Set-Content -LiteralPath $tmp -Encoding UTF8

foreach($f in $CoreFiles){
  if(Test-Path $f){
    $h = (Get-FileHash -Algorithm SHA256 -LiteralPath $f).Hash.ToLower()
    "{0} *{1}" -f $h, $f | Add-Content -LiteralPath $tmp -Encoding UTF8
  } else {
    "MISSING *$f" | Add-Content -LiteralPath $tmp -Encoding UTF8
  }
}

# Atomic replace: move temp into place (overwrites)
Move-Item -LiteralPath $tmp -Destination $baselineOut -Force

Write-Host "[OK] Rebuilt baseline (atomic):"
Write-Host "     $baselineOut"

