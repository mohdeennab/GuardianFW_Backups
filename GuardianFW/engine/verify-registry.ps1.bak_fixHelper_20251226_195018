$ErrorActionPreference="Stop"
. "C:\ProgramData\GuardianFW\engine\lib-timeout.ps1"
$root="C:\ProgramData\GuardianFW"
. "C:\ProgramData\GuardianFW\engine\lib-ps-timeout.ps1"
$polPath="$root\policies\registry-policy.json"
$evDir="$root\evidence\registry"
New-Item -ItemType Directory -Path $evDir -Force | Out-Null

if (!(Test-Path $polPath)) { throw "Missing: $polPath" }
$pol = Get-Content $polPath -Raw | ConvertFrom-Json

$drift=@()
$missingKeys=@()

foreach($t in $pol.targets){
  if(!(Test-Path $t.path)){
    $missingKeys += $t.path
    continue
  }
  try { $cur = Invoke-WithTimeout -TimeoutSec 6 -ScriptBlock { Get-ItemProperty -Path $using:t.path -ErrorAction Stop } } catch { $cur = $null; $global:__GuardianFW_VerifyRegistryTimeout = $_.Exception.Message }
  foreach($v in $t.values){
    $exists = ($cur.PSObject.Properties.Name -contains $v.name)
    if(!$exists){
      $drift += @{ key=$t.path; value=$v.name; issue="missing"; expected=$v.value; actual=$null }
      continue
    }
    $actual = $cur.($v.name)
    if (($actual | Out-String) -ne (($v.value) | Out-String)){
      $drift += @{ key=$t.path; value=$v.name; issue="modified"; expected=$v.value; actual=$actual }
    }
  }
}

$result=@{
  timestamp=(Get-Date).ToString("s")
  status= if($missingKeys.Count -eq 0 -and $drift.Count -eq 0){"OK"}else{"DRIFT"}
  missingKeys=$missingKeys
  drift=$drift
}

$result | ConvertTo-Json -Depth 10 | Out-File "$evDir\verify-$(Get-Date -Format yyyyMMdd-HHmmss).json" -Encoding UTF8
$result

