Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

function Get-DedupeKey([string]$ev,$data){
  $pairs = @($ev.ToLowerInvariant().Trim())
  if($data){
    foreach($k in ($data.Keys | Sort-Object)){
      $v = ""
      try { $v = ([string]$data[$k]).Trim() } catch { $v = "" }
      $pairs += ("{0}={1}" -f $k.ToLowerInvariant().Trim(), $v)
    }
  }
  $raw = ($pairs -join "|")
  $sha=[System.Security.Cryptography.SHA256]::Create()
  try{
    return (-join ($sha.ComputeHash([Text.Encoding]::UTF8.GetBytes($raw)) | ForEach-Object { $_.ToString("x2") }))
  } finally { $sha.Dispose() }
}

function Load-DedupeMap([string]$stateFile){
  $map = @{}
  if(Test-Path -LiteralPath $stateFile){
    try {
      $obj = Get-Content -LiteralPath $stateFile -Raw -Encoding UTF8 | ConvertFrom-Json
      if($obj){
        foreach($p in $obj.PSObject.Properties){
          $map[$p.Name] = $p.Value
        }
      }
    } catch { $map = @{} }
  }
  return $map
}

function Save-DedupeMap([hashtable]$map,[string]$stateFile){
  $tmp = "$stateFile.tmp"
  ($map | ConvertTo-Json -Depth 4) | Set-Content -LiteralPath $tmp -Encoding UTF8 -Force
  Move-Item -LiteralPath $tmp -Destination $stateFile -Force
}

function Should-LogEvent([string]$Root,[string]$ev,$data){
  $stateDir  = Join-Path $Root "state"
  $stateFile = Join-Path $stateDir "audit-dedupe.json"
  if(!(Test-Path -LiteralPath $stateDir)){ New-Item -ItemType Directory -Path $stateDir -Force | Out-Null }

  $ttl = switch($ev){
    "lolbin_detected" { 3600 }
    "dns_blocked"     { 300  }
    "doh_blocked"     { 300  }
    "tcp443_seen"     { 60   }  # IMPORTANT: throttle noisy telemetry
    default           { 120  }
  }

  $key = Get-DedupeKey $ev $data
  $now = [DateTime]::UtcNow

  $mutexName = "Global\GuardianFW_AuditDedupe"
  $mtx = New-Object System.Threading.Mutex($false, $mutexName)
  try {
    if(-not $mtx.WaitOne(5000)){
      return $true  # fail-safe
    }

    $map = Load-DedupeMap $stateFile

    # GC (7 days)
    $maxAge = [TimeSpan]::FromDays(7)
    foreach($k in @($map.Keys)){
      try {
        $t = [DateTime]::Parse([string]$map[$k])
        if(($now - $t) -gt $maxAge){ $map.Remove($k) }
      } catch { $map.Remove($k) }
    }

    if($map.ContainsKey($key)){
      try {
        $last = [DateTime]::Parse([string]$map[$key])
        if(($now - $last).TotalSeconds -lt $ttl){ return $false }
      } catch {}
    }

    $map[$key] = $now.ToString("o")
    try { Save-DedupeMap $map $stateFile } catch { return $true }

    return $true
  } finally {
    try { $mtx.ReleaseMutex() } catch {}
    $mtx.Dispose()
  }
}
