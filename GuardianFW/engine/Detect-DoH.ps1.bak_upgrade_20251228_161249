param(
  [switch]$SelfTest,
  [switch]$KeepArtifacts,
  [int]$WindowSeconds = 6
)

$ErrorActionPreference="SilentlyContinue"

# GuardianFW Detect-DoH (ETW via netsh)
# Exit: 0 = clean, 20 = suspicious (DoH-resolver IP seen on TCP 443)

$dohIps = @("1.1.1.1","1.0.0.1","8.8.8.8","8.8.4.4","9.9.9.9","149.112.112.112")

$eventsDir = "C:\ProgramData\GuardianFW\events"
New-Item -ItemType Directory -Path $eventsDir -Force | Out-Null
$logPath = Join-Path $eventsDir "doh-detect.jsonl"

$etl = Join-Path $eventsDir "tcpip_doh.etl"
$txt = Join-Path $eventsDir "tcpip_doh.txt"

function Stop-TraceQuiet { try { netsh trace stop | Out-Null } catch {} }

# Ensure no prior trace is running
Stop-TraceQuiet

# Clean artifacts before run
try { Remove-Item $etl,$txt -Force -EA SilentlyContinue | Out-Null } catch {}

try {
  # Start ETW trace
  netsh trace start capture=no report=no tracefile="$etl" provider=Microsoft-Windows-TCPIP level=5 keywords=0xFFFFFFFF | Out-Null

  # Optional self-test traffic INSIDE capture window
  if($SelfTest){
    Start-Sleep -Milliseconds 200
    $u="https://cloudflare-dns.com/dns-query?name=example.com&type=A"
    curl.exe -s --http1.1 "$u" --resolve cloudflare-dns.com:443:1.1.1.1 -H "accept: application/dns-json" | Out-Null
  }

  Start-Sleep -Seconds $WindowSeconds
}
finally {
  Stop-TraceQuiet
}

# Convert trace
netsh trace convert input="$etl" output="$txt" | Out-Null

# Read RAW so regex survives wrapping/newlines
$blob = ""
try { $blob = Get-Content -LiteralPath $txt -Raw -EA SilentlyContinue } catch {}

if(-not $blob){
  if(-not $KeepArtifacts){ try { Remove-Item $etl,$txt -Force -EA SilentlyContinue | Out-Null } catch {} }
  exit 0
}

$hits = @()

# STRONG: "... remote=IP:443) ... connect completed. PID = N"
$reStrong = [regex]'(?is)(?:remote|Remote)\s*=\s*(\d{1,3}(?:\.\d{1,3}){3}):443\)\s*connect\s+completed\.\s*PID\s*=\s*(\d+)'
foreach($m in $reStrong.Matches($blob)){
  $rip = $m.Groups[1].Value
  if($dohIps -notcontains $rip){ continue }
  $pid = [int]$m.Groups[2].Value

  $proc="unknown"
  if($pid -gt 0){ try { $p=Get-Process -Id $pid -EA SilentlyContinue; if($p){$proc=$p.ProcessName} } catch {} }

  $hits += [pscustomobject]@{
    ts       = (Get-Date).ToString("s")
    remote   = $rip
    port     = 443
    pid      = $pid
    proc     = $proc
    strength = "strong"
    source   = "etw_tcpip_connect_completed"
  }
}

# WEAK: "... remote=IP:443) exists. State = ... PID = N" (often PID=0)
$reWeak = [regex]'(?is)(?:remote|Remote)\s*=\s*(\d{1,3}(?:\.\d{1,3}){3}):443\)\s*exists\.\s*State\s*=\s*\d+\([^)]+\),\s*PID\s*=\s*(\d+)'
foreach($m in $reWeak.Matches($blob)){
  $rip = $m.Groups[1].Value
  if($dohIps -notcontains $rip){ continue }
  if($hits | Where-Object { $_.remote -eq $rip -and $_.strength -eq "strong" }){ continue }

  $pid = [int]$m.Groups[2].Value
  $proc="unknown"
  if($pid -gt 0){ try { $p=Get-Process -Id $pid -EA SilentlyContinue; if($p){$proc=$p.ProcessName} } catch {} }

  $hits += [pscustomobject]@{
    ts       = (Get-Date).ToString("s")
    remote   = $rip
    port     = 443
    pid      = $pid
    proc     = $proc
    strength = "weak"
    source   = "etw_tcpip_exists_state"
  }
}

if(-not $KeepArtifacts){
  try { Remove-Item $etl,$txt -Force -EA SilentlyContinue | Out-Null } catch {}
}

if($hits.Count -gt 0){
  $hits | ForEach-Object { ($_ | ConvertTo-Json -Compress) } | Add-Content -LiteralPath $logPath -Encoding UTF8
  exit 20
}

exit 0
