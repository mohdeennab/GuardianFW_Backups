$ErrorActionPreference = "Stop"

$root   = "C:\ProgramData\GuardianFW"
$logDir = Join-Path $root "logs"
New-Item -ItemType Directory -Path $logDir -Force | Out-Null

$outFile = Join-Path $logDir "health-task.out"
$tmpOut  = Join-Path $logDir "health-child.stdout.txt"
$tmpErr  = Join-Path $logDir "health-child.stderr.txt"
$latest  = Join-Path $root "evidence\health\health-latest.json"
$child   = Join-Path $root "engine\health.ps1"

function Log([string]$s){
  try { $s | Add-Content -Encoding UTF8 -Path $outFile -ErrorAction Stop } catch {}
}

# optional transcript (best-effort)
try {
  $tlog = Join-Path $logDir ("run-health.transcript.{0}.txt" -f (Get-Date -Format yyyyMMdd-HHmmss))
  Start-Transcript -Path $tlog -Force | Out-Null
} catch {}

try {
  Log ("==== {0} START ====" -f (Get-Date -Format s))
  Log ("WHOAMI: {0}" -f (whoami))
  Log ("PSVersion: {0}" -f ($PSVersionTable.PSVersion.ToString()))
  Log ("RUN (child): {0}" -f $child)

  if(!(Test-Path $child)){ throw "Missing child script: $child" }

  Remove-Item -LiteralPath $tmpOut, $tmpErr -EA SilentlyContinue
  & powershell.exe -NoProfile -ExecutionPolicy Bypass -File $child 1>$tmpOut 2>$tmpErr
  $childExit = $LASTEXITCODE
  Log ("CHILD_EXITCODE: {0}" -f $childExit)

  if(Test-Path $latest){
    try {
      $hj = Get-Content $latest -Raw -Encoding UTF8 | ConvertFrom-Json
      Log ("LATEST_TIMESTAMP: {0}" -f $hj.timestamp)
      Log ("LATEST_OVERALL:   {0}" -f $hj.overall)
    } catch {
      Log ("LATEST_PARSE_ERROR: {0}" -f $_.Exception.Message)
    }

    Log "---- STDOUT ----"
    if(Test-Path $tmpOut){ try { Log (Get-Content $tmpOut -Raw -Encoding UTF8) } catch {} }

    Log "---- STDERR ----"
    if(Test-Path $tmpErr){ try { Log (Get-Content $tmpErr -Raw -Encoding UTF8) } catch {} }

    Log "---- HEALTH-LATEST.JSON ----"
    try { Log (Get-Content $latest -Raw -Encoding UTF8) } catch {}
  } else {
    Log "LATEST_FILE: (missing)"
  }

  $exit = 2
  try {
    if(Test-Path $latest){
      $ov = (Get-Content $latest -Raw -Encoding UTF8 | ConvertFrom-Json).overall
      if($ov -eq "OK"){ $exit = 0 }
      elseif($ov -eq "DRIFT"){ $exit = 1 }
      else { $exit = 2 }
    }
  } catch { $exit = 2 }

  Log ("WRAPPER_RETURNING: {0}" -f $exit)
  Log ("==== {0} END ====" -f (Get-Date -Format s))
  exit $exit
}
catch {
  Log ("WRAPPER_ERROR: {0}" -f $_.Exception.Message)
  try { Log ("AT: {0}" -f $_.InvocationInfo.PositionMessage) } catch {}
  Log ("WRAPPER_RETURNING: 2")
  Log ("==== {0} END ====" -f (Get-Date -Format s))
  exit 2
}
finally {
  try { Stop-Transcript | Out-Null } catch {}
}