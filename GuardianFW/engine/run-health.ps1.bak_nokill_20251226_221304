$ErrorActionPreference = "Continue"

$root   = "C:\ProgramData\GuardianFW"
$logDir = Join-Path $root "logs"
New-Item -ItemType Directory -Path $logDir -Force | Out-Null

$outFile = Join-Path $logDir "health-task.out"
$tmpOut  = Join-Path $logDir "health-child.stdout.txt"
$tmpErr  = Join-Path $logDir "health-child.stderr.txt"
$health  = Join-Path $root "engine\health.ps1"
$ps      = "$env:WINDIR\System32\WindowsPowerShell\v1.0\powershell.exe"

function Log([string]$s){
  $s | Add-Content -Encoding UTF8 $outFile
}

Log ("==== {0} START ====" -f (Get-Date -Format s))
Log ("WHOAMI: {0}" -f [System.Security.Principal.WindowsIdentity]::GetCurrent().Name)
Log ("PSVersion: {0}" -f $PSVersionTable.PSVersion)
Log ("RUN (child): {0}" -f $health)

Remove-Item -Force $tmpOut,$tmpErr -ErrorAction SilentlyContinue

try {
  $p = Start-Process -FilePath $ps -ArgumentList @(
      "-NoProfile","-ExecutionPolicy","Bypass","-File",$health
    ) -PassThru -WindowStyle Hidden `
    -RedirectStandardOutput $tmpOut `
    -RedirectStandardError  $tmpErr

  # Wait max 20 seconds (tune if you want)
  $timeoutSec = 120
  $ok = Wait-Process -Id $p.Id -Timeout $timeoutSec -ErrorAction SilentlyContinue

  if(-not $ok){
  Log ("TIMEOUT: child still running after {0}s. NOT killing (let it finish). PID={1}" -f $timeoutSec,$p.Id)
  Log "CHILD_EXITCODE: TIMEOUT_RUNNING"
 else {
    Log ("CHILD_EXITCODE: {0}" -f $p.ExitCode)
  }

  if(Test-Path $tmpOut){
    Log "---- STDOUT ----"
    Get-Content $tmpOut -ErrorAction SilentlyContinue | ForEach-Object { Log $_ }
  }
  if(Test-Path $tmpErr){
    $errText = Get-Content $tmpErr -ErrorAction SilentlyContinue
    if($errText){
      Log "---- STDERR ----"
      $errText | ForEach-Object { Log $_ }
    }
  }

  # Append latest JSON snapshot (if present)
  try {
    $latest = Join-Path $root "evidence\health\health-latest.json"
    if(Test-Path $latest){
      Log "---- HEALTH-LATEST.JSON ----"
      Log (Get-Content $latest -Raw)
    }
  } catch {}
}
catch {
  Log ("WRAPPER_ERROR: {0}" -f $_.Exception.Message)
}

Log ("==== {0} END ====" -f (Get-Date -Format s))
exit 0

