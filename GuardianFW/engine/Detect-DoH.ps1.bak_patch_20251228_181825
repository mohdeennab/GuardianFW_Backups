param(
  [switch]$SelfTest,
  [switch]$KeepArtifacts,
  [int]$WindowSeconds = 6,

  # Weak-only triggers require repeats (avoid false positives)
  [int]$WeakRepeatThreshold = 2,
  [int]$WeakRepeatWindowSeconds = 30
)

$ErrorActionPreference="SilentlyContinue"

$dohIps = @("1.1.1.1","1.0.0.1","8.8.8.8","8.8.4.4","9.9.9.9","149.112.112.112")

$eventsDir = "C:\ProgramData\GuardianFW\events"
New-Item -ItemType Directory -Path $eventsDir -Force | Out-Null
$logPath   = Join-Path $eventsDir "doh-detect.jsonl"
$statePath = Join-Path $eventsDir "doh-detect.state.json"

$etl = Join-Path $eventsDir "tcpip_doh.etl"
$txt = Join-Path $eventsDir "tcpip_doh.txt"

function Stop-TraceQuiet { try { netsh trace stop | Out-Null } catch {} }

function Load-State {
  if(Test-Path $statePath){
    try { return (Get-Content -LiteralPath $statePath -Raw -EA SilentlyContinue | ConvertFrom-Json) } catch {}
  }
  return [pscustomobject]@{ weak_hits = @() }
}

function Save-State($state){
  try { $state | ConvertTo-Json -Compress | Set-Content -LiteralPath $statePath -Encoding UTF8 -Force } catch {}
}

function Add-EventLog($obj){
  try { ($obj | ConvertTo-Json -Compress) | Add-Content -LiteralPath $logPath -Encoding UTF8 } catch {}
}

function Proc-Name([int]$pid){
  if($pid -le 0){ return "unknown" }
  try { $p = Get-Process -Id $pid -EA SilentlyContinue; if($p){ return $p.ProcessName } } catch {}
  return "unknown"
}

# ---- capture ----
Stop-TraceQuiet
try { Remove-Item $etl,$txt -Force -EA SilentlyContinue | Out-Null } catch {}

try {
  netsh trace start capture=no report=no tracefile="$etl" provider=Microsoft-Windows-TCPIP level=5 keywords=0xFFFFFFFF | Out-Null

  if($SelfTest){
    Start-Sleep -Milliseconds 200
    $u="https://cloudflare-dns.com/dns-query?name=example.com&type=A"
    curl.exe -s --http1.1 "$u" --resolve cloudflare-dns.com:443:1.1.1.1 -H "accept: application/dns-json" | Out-Null
  }

  Start-Sleep -Seconds $WindowSeconds
}
finally {
  Stop-TraceQuiet
}

netsh trace convert input="$etl" output="$txt" | Out-Null

$blob = ""
try { $blob = Get-Content -LiteralPath $txt -Raw -EA SilentlyContinue } catch {}

if(-not $blob){
  if(-not $KeepArtifacts){ try { Remove-Item $etl,$txt -Force -EA SilentlyContinue | Out-Null } catch {} }
  exit 0
}

# ---- robust parsing ----
# Strategy: find blocks containing remote=<ip>:443 and then classify by keywords found nearby.
# We grab up to 600 chars after the remote match, so line wrapping/order doesn't matter.
$hits = @()
$weakSeen = @()

foreach($ip in $dohIps){
  $reBlock = [regex]("(?is)(?:remote|Remote)\s*=\s*"+[regex]::Escape($ip)+":443\)(.{0,600})")
  foreach($m in $reBlock.Matches($blob)){
    $tail = $m.Groups[1].Value

    # event type detection (wrap-safe)
    $isStrong = ($tail -match '(?is)connect\s+completed')
    $isMed    = ($tail -match '(?is)requested\s+to\s+connect|connect\s+proceeding')
    $isWeak   = ($tail -match '(?is)\bexists\.')

    if(-not ($isStrong -or $isMed -or $isWeak)){ continue }

    # PID anywhere in the block tail (or shortly after)
    $pid = 0
    $mp  = [regex]::Match($tail, '(?is)\bPID\s*=\s*(\d+)')
    if($mp.Success){ $pid = [int]$mp.Groups[1].Value }

    $strength = if($isStrong){"strong"} elseif($isMed){"medium"} else {"weak"}
    $source   = if($isStrong){"etw_tcpip_connect_completed"}
                elseif($isMed){"etw_tcpip_preconnect"}
                else {"etw_tcpip_exists_state"}

    $proc = Proc-Name $pid

    $obj = [pscustomobject]@{
      ts       = (Get-Date).ToString("s")
      remote   = $ip
      port     = 443
      pid      = $pid
      proc     = $proc
      strength = $strength
      source   = $source
    }

    $hits += $obj
    if($strength -eq "weak"){ $weakSeen += $ip }
  }
}

# Optional cleanup
if(-not $KeepArtifacts){
  try { Remove-Item $etl,$txt -Force -EA SilentlyContinue | Out-Null } catch {}
}

# ---- Decision Logic ----
# strong/medium => immediate suspicious
if($hits | Where-Object { $_.strength -in @("strong","medium") }){
  foreach($h in $hits){ Add-EventLog $h }
  exit 20
}

# weak-only => require repeats within window
if($hits.Count -gt 0){
  $state = Load-State
  $now = Get-Date
  $cut = $now.AddSeconds(-1 * $WeakRepeatWindowSeconds)

  $recent = @()
  foreach($w in $state.weak_hits){
    try { if([datetime]$w.ts -ge $cut){ $recent += $w } } catch {}
  }

  foreach($rip in ($weakSeen | Select-Object -Unique)){
    $recent += [pscustomobject]@{ ts = $now.ToString("o"); remote = $rip }
  }

  $state.weak_hits = $recent
  Save-State $state

  foreach($rip in ($weakSeen | Select-Object -Unique)){
    $count = @($state.weak_hits | Where-Object { $_.remote -eq $rip }).Count
    if($count -ge $WeakRepeatThreshold){
      foreach($h in $hits){ Add-EventLog $h }
      exit 20
    }
  }

  # weak seen but not enough repeats => log and exit clean
  foreach($h in $hits){ Add-EventLog $h }
  exit 0
}

exit 0
