$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

# ---- Root ----
$script:root = "C:\ProgramData\GuardianFW"
if([string]::IsNullOrWhiteSpace($script:root)){ $script:root = "C:\ProgramData\GuardianFW" }
$root = $script:root

# ---- IO ----
$logDir = Join-Path $root "logs"
New-Item -ItemType Directory -Path $logDir -Force | Out-Null
$trace = Join-Path $logDir "health-trace.txt"
$lock  = Join-Path $logDir "health.lock"

function Trace([string]$msg){
  ("[{0}] {1}" -f (Get-Date -Format s), $msg) | Add-Content -Encoding UTF8 $trace
}

function To-Obj([object]$x){
  # If a script returns JSON text, parse it; otherwise return the object.
  if($null -eq $x){ return $null }

  if($x -is [string]){
    $s = $x.Trim()
    if($s.StartsWith("{") -or $s.StartsWith("[")){
      try { return ($s | ConvertFrom-Json) } catch { return $x }
    }
    return $x
  }

  # Sometimes output is string[] lines; join and attempt JSON parse
  if($x -is [object[]]){
    try {
      $joined = (@($x) -join "
").Trim()
      if($joined.StartsWith("{") -or $joined.StartsWith("[")){
        return ($joined | ConvertFrom-Json)
      }
    } catch {}
  }

  return $x
}

function Get-Prop([object]$obj, [string]$name, [string]$fallback=""){
  if($null -eq $obj){ return $fallback }
  try {
    if($null -ne $obj.PSObject.Properties[$name]){
      $v = $obj.$name
      if($null -eq $v){ return $fallback }
      return [string]$v
    }
  } catch {}
  return $fallback
}

# ---- single instance lock ----
try { Remove-Item -LiteralPath $lock -Force -EA SilentlyContinue } catch {}
if(Test-Path -LiteralPath $lock){
  Trace "LOCKED: previous run still active; exiting."
  exit 0
}
"locked 2025-12-27T23:21:37 pid=10900" | Set-Content -Encoding UTF8 $lock

try {
  Trace "HEALTH_START"

  # ---- mode ----
  $mode = $env:GFW_MODE
  if([string]::IsNullOrWhiteSpace($mode)){ $mode = "PROD" }
  $mode = $mode.ToUpperInvariant()
  if($mode -ne "DEV" -and $mode -ne "PROD"){ $mode = "PROD" }

  # ---- probes ----
  $fwOut  = & "$root\engine\verify-firewall.ps1"
  $regOut = & "$root\engine\verify-registry.ps1"
  $fw = if($fwOut -is [string] -or $fwOut -is [object[]]){ To-Obj $fwOut } else { $fwOut }
  $reg = if($regOut -is [string] -or $regOut -is [object[]]){ To-Obj $regOut } else { $regOut }

  # ---- verify-integrity in-process (no child powershell.exe) ----
  $prevMode = $null
  if(Test-Path Env:\GFW_MODE){ $prevMode = $env:GFW_MODE }
  $env:GFW_MODE = $mode
  $viOut = & "$root\engine\verify-integrity.ps1"
  if($null -ne $prevMode){ $env:GFW_MODE = $prevMode } else { Remove-Item Env:\GFW_MODE -EA SilentlyContinue }
  $vi = To-Obj $viOut

  # ---- statuses ----
  $firewallStatus = Get-Prop $fw  "status" "ERR"
  $registryStatus = Get-Prop $reg "status" "ERR"

  $viStatus  = Get-Prop $vi "status" ""
  $warnCount = 0
  try {
    if($null -ne $vi -and $null -ne $vi.PSObject.Properties["warnings"]){
      $warnCount = @($vi.warnings).Count
    }
  } catch { $warnCount = 0 }

  if($viStatus -eq "OK"){
    if($warnCount -gt 0){ $integrityMsg = "OK(warnings=$warnCount)" } else { $integrityMsg = "OK" }
  } else {
    $integrityMsg = "DRIFT"
  }

  $overall = if($firewallStatus -eq "OK" -and $registryStatus -eq "OK" -and $integrityMsg -like "OK*"){"OK"}else{"DRIFT"}

  # ---- single-line output (scheduler) ----
  Write-Host ("HEALTH: {0}  (firewall={1}, registry={2}, integrity={3})" -f $overall, $firewallStatus, $registryStatus, $integrityMsg)

  # ---- evidence ----
  $evDir = Join-Path $root "evidence\health"
  New-Item -ItemType Directory -Path $evDir -Force | Out-Null

  $out = [ordered]@{
    timestamp = (Get-Date).ToString("s")
    mode      = $mode
    overall   = $overall
    firewall  = $fw
    registry  = $reg
    integrity = $vi
  }

  $fn = "health-{0}.json" -f (Get-Date -Format yyyyMMdd-HHmmss)
  ($out | ConvertTo-Json -Depth 12) | Out-File (Join-Path $evDir $fn) -Encoding UTF8
  ($out | ConvertTo-Json -Depth 12) | Out-File (Join-Path $evDir "health-latest.json") -Encoding UTF8

  Trace ("HEALTH_END overall={0} wrote={1}" -f $overall, $fn)

  # Exit code contract: OK=0, else=20  (PS5.1 safe)
  if($overall -eq "OK"){ exit 0 } else { exit 20 }

} catch {
  try {
    Trace ("HEALTH_ERROR: " + $_.Exception.Message)
    Trace ("AT: " + [string]$_.InvocationInfo.PositionMessage)
  } catch {}

  Write-Host "HEALTH: DRIFT  (firewall=ERR, registry=ERR, integrity=ERR)"
  Write-Host ("[ERROR] " + $_.Exception.Message)
  exit 20

} finally {
  try { Remove-Item -LiteralPath $lock -Force -EA SilentlyContinue } catch {}
}
