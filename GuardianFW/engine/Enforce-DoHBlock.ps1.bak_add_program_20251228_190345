param(
  [switch]$Apply,                 # actually create rules
  [switch]$Remove,                # remove GuardianFW DoH rules
  [string[]]$DoHIps = @("1.1.1.1","1.0.0.1","8.8.8.8","8.8.4.4","9.9.9.9","149.112.112.112"),
  [int]$RemotePort = 443,
  [string]$RulePrefix = "GuardianFW Block DoH"
)

$ErrorActionPreference="Stop"

function Ensure-Admin {
  $id = [Security.Principal.WindowsIdentity]::GetCurrent()
  $p  = New-Object Security.Principal.WindowsPrincipal($id)
  if(-not $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)){
    throw "Run PowerShell as Administrator."
  }
}

function RuleName([string]$ip){
  return "$RulePrefix ${ip}:$RemotePort"
}

Ensure-Admin

if($Remove){
  $rules = Get-NetFirewallRule -DisplayName "$RulePrefix*" -EA SilentlyContinue
  if($rules){
    $rules | Remove-NetFirewallRule -EA SilentlyContinue
    Write-Host "[OK] Removed rules: $RulePrefix*" -ForegroundColor Green
  } else {
    Write-Host "[OK] No rules to remove." -ForegroundColor Yellow
  }
  exit 0
}

# show what would happen
Write-Host "Target DoH IPs: $($DoHIps -join ', ')" -ForegroundColor Cyan
Write-Host "Action: Block outbound TCP to RemotePort=$RemotePort" -ForegroundColor Cyan

foreach($ip in $DoHIps){
  $name = RuleName $ip

  $existing = Get-NetFirewallRule -DisplayName $name -EA SilentlyContinue
  if($existing){
    Write-Host "Already exists: $name" -ForegroundColor Yellow
    continue
  }

  if(-not $Apply){
    Write-Host "DRY RUN: would create rule: $name" -ForegroundColor Gray
    continue
  }

  New-NetFirewallRule `
    -DisplayName $name `
    -Direction Outbound `
    -Action Block `
    -Enabled True `
    -Profile Any `
    -Protocol TCP `
    -RemotePort $RemotePort `
    -RemoteAddress $ip `
    -Program Any `
    -Description "GuardianFW: block DoH resolver endpoint over TCP/443 (enforced on detection)." | Out-Null

  Write-Host "[OK] Created: $name" -ForegroundColor Green
}

exit 0

