# run-health-phase1.ps1
# GuardianFW  Phase 1 Health Wrapper (FINAL PS5-SAFE)
# - Always parses
# - Robust logging (retry to avoid file locks)
# - Runs probes if present (no failure if missing)
# - Supports Phase 3 DNS policy gate when present

$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

$Root = "C:\ProgramData\GuardianFW"
$Log  = Join-Path $Root "logs\health-task.ps.out"
$EngineDir = Join-Path $Root "engine"

function Ensure-Dir([string]$p){
  if(!(Test-Path -LiteralPath $p)){
    New-Item -ItemType Directory -Path $p -Force | Out-Null
  }
}
Ensure-Dir (Split-Path -Parent $Log)

function Add-ContentWithRetry([string]$Path,[string]$Value,[int]$tries=40,[int]$sleepMs=75){
  for($i=1; $i -le $tries; $i++){
    try {
      Add-Content -LiteralPath $Path -Value $Value -Encoding UTF8
      return
    } catch {
      Start-Sleep -Milliseconds $sleepMs
    }
  }
  # last attempt throws if still locked
  Add-Content -LiteralPath $Path -Value $Value -Encoding UTF8
}

function Run-Probe([string]$ProbePath){
  # returns: @{ exit=<int>; out=<string>; err=<string> }
  $outFile = Join-Path $env:TEMP ("gfw_probe_out_{0}.txt" -f ([guid]::NewGuid().ToString("N")))
  $errFile = Join-Path $env:TEMP ("gfw_probe_err_{0}.txt" -f ([guid]::NewGuid().ToString("N")))

  $code = 0
  try {
    & powershell.exe -NoProfile -ExecutionPolicy Bypass -File $ProbePath 1> $outFile 2> $errFile
    $code = $LASTEXITCODE
  } catch {
    $code = 70
    try { Set-Content -LiteralPath $errFile -Value ($_.Exception.Message) -Encoding UTF8 -Force } catch {}
  }

  $out = ""; $err = ""
  try { if(Test-Path -LiteralPath $outFile){ $out = (Get-Content -LiteralPath $outFile -Raw -Encoding UTF8) } } catch {}
  try { if(Test-Path -LiteralPath $errFile){ $err = (Get-Content -LiteralPath $errFile -Raw -Encoding UTF8) } } catch {}

  try { Remove-Item -LiteralPath $outFile,$errFile -Force -ErrorAction SilentlyContinue | Out-Null } catch {}

  return @{ exit = [int]$code; out = $out; err = $err }
}


function Out-Task([string]$msg){
  Add-ContentWithRetry -Path $Log -Value $msg
}

function Stamp([string]$label){
  $ts = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss.ff")
  Out-Task ("==== {0} {1} (task) ====" -f $ts, $label)
}

function Safe([scriptblock]$sb){
  try { & $sb } catch { return $_ }
  return $null
}

function ErrText($e){
  if($null -eq $e){ return "" }
  if($e -is [System.Management.Automation.ErrorRecord]){ return [string]$e.Exception.Message }
  if($e -is [System.Exception]){ return [string]$e.Message }
  return [string]$e
}

# ---- Start logging ----
Stamp "START"
Out-Task ([Environment]::UserName)
Out-Task ("PWD={0}" -f (Get-Location).Path)
Out-Task ("PS={0}" -f (Join-Path $PSHOME "powershell.exe"))

$psExe = Join-Path $PSHOME "powershell.exe"
$psExists = if(Test-Path -LiteralPath $psExe){"YES"} else {"NO"}
Out-Task ("PS_EXISTS={0}" -f $psExists)

Out-Task "BEFORE_POWERSHELL"

# ---- Probes ----
# IMPORTANT: use only scripts you actually have
$probes = @(
  "apply-dns-policy-phase3.ps1",     # Phase 3 gate (optional)
  "Check-DnsDrift.ps1",              # optional
  "verify-integrity.ps1",            # should exist
  "verify-firewall.ps1",             # optional
  "verify-registry.ps1",             # optional
  "health.ps1",                      # optional
  "write-decision-heartbeat.ps1"     # optional
)

$overallExit = 0
$failures = New-Object 'System.Collections.Generic.List[string]'

foreach($p in $probes){
  $probePath = Join-Path $EngineDir $p

  if(!(Test-Path -LiteralPath $probePath)){
    Out-Task ("[INFO] Missing probe (skipped): {0}" -f $probePath)
    continue
  }

  $r = Run-Probe -ProbePath $probePath
  $code = [int]$r.exit

    if($code -ne 0 -and -not [string]::IsNullOrWhiteSpace([string]$r.err)){
    if($overallExit -eq 0){ $overallExit = 50 }
    $msg = ("Probe stderr (exit={0}): {1} :: {2}" -f $code, $p, ($r.err.Trim()))
    $failures.Add($msg) | Out-Null
    Out-Task ("[[TASKTRACE_ERROR]] " + $msg)
    continue
  }

  Out-Task ("Probe {0} exit={1}" -f $p, $code)
  if(-not [string]::IsNullOrWhiteSpace([string]$r.out)){
    $line = ($r.out -split "(`r`n|`n)")[0]
    if(-not [string]::IsNullOrWhiteSpace($line)){
      Out-Task ("Probe {0} stdout: {1}" -f $p, $line.Trim())
    }
  }

  if($code -ne 0){
    if($overallExit -eq 0){ $overallExit = $code }
    $failures.Add(("Probe failed: {0} exit={1}" -f $p, $code)) | Out-Null
  }
}

# ---- tiny health summary line ----
if($overallExit -eq 0){
  Out-Task "[GFW] health=OK"
} else {
  Out-Task ("[GFW] health=ERROR exit={0}" -f $overallExit)
  foreach($f in $failures){ Out-Task ("[GFW] " + $f) }
}

Out-Task "[[TASKTRACE_LASTEXIT]]"
Out-Task "AFTER_POWERSHELL"
Stamp "END"

exit $overallExit




