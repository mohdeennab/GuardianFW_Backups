# Enforce-DnsPolicy.ps1
# Hosts-file based DNS enforcement (Phase 2 starter).
$ErrorActionPreference="Stop"
Set-StrictMode -Version Latest

function Get-GfwHostsPath { Join-Path $env:SystemRoot "System32\drivers\etc\hosts" }

function Get-GfwDnsPolicyPath { "C:\ProgramData\GuardianFW\policy\dns-policy.json" }

function Get-GfwUtcIso { (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ") }

function Get-GfwDnsPolicy {
  $p = Get-GfwDnsPolicyPath
  if(-not (Test-Path $p)){ throw "DNS policy missing: $p" }
  (Get-Content -LiteralPath $p -Raw -Encoding UTF8) | ConvertFrom-Json
}

function Remove-GuardianBlock([string]$Text){
  # Remove existing managed block, if present.
  return ($Text -replace '(?s)# --- GuardianFW managed entries ---.*?# --- End GuardianFW managed entries ---\s*', '')
}

function Build-GuardianBlock($policy){
  $lines = New-Object System.Collections.Generic.List[string]
  $lines.Add("# --- GuardianFW managed entries ---")
  $lines.Add("# policy_version=" + [string]$policy.version + " updated_utc=" + [string]$policy.updated_utc)
  foreach($d in @($policy.block)){
    if([string]::IsNullOrWhiteSpace($d)){ continue }
    $lines.Add("0.0.0.0 " + $d.Trim().ToLower())
  }
  $lines.Add("# --- End GuardianFW managed entries ---")
  return ($lines -join "`r`n")
}

function Apply-GfwDnsPolicy {
  # Returns hashtable: status=NOOP|CHANGED|AUDIT  count=<int> hosts=<path> policy=<path>
  $policy = Get-GfwDnsPolicy
  $mode   = [string]$policy.mode
  if([string]::IsNullOrWhiteSpace($mode)){ $mode = "enforce" }
  $mode = $mode.ToLower()

  $hostsPath = Get-GfwHostsPath
  $raw = ""
  try { $raw = Get-Content -LiteralPath $hostsPath -Raw -Encoding ASCII } catch { $raw = "" }

  $clean = Remove-GuardianBlock $raw
  $block = Build-GuardianBlock $policy
  $new   = ($clean.TrimEnd() + "`r`n`r`n" + $block + "`r`n")

  $count = 0
  foreach($d in @($policy.block)){
    if(-not [string]::IsNullOrWhiteSpace($d)){ $count++ }
  }

  if($mode -eq "audit"){
    return @{ status="AUDIT"; count=$count; hosts=$hostsPath; policy=(Get-GfwDnsPolicyPath); ts=(Get-GfwUtcIso) }
  }

  if($new -ne $raw){
    # NOTE: hosts file is traditionally ASCII. Keep it ASCII.
    Set-Content -LiteralPath $hostsPath -Value $new -Encoding ASCII
    return @{ status="CHANGED"; count=$count; hosts=$hostsPath; policy=(Get-GfwDnsPolicyPath); ts=(Get-GfwUtcIso) }
  }

  return @{ status="NOOP"; count=$count; hosts=$hostsPath; policy=(Get-GfwDnsPolicyPath); ts=(Get-GfwUtcIso) }
}