Set-StrictMode -Version Latest
$ErrorActionPreference="Stop"

$out = "C:\ProgramData\GuardianFW\policy\doh-ips.json"

$providers = @(
  @{ name="Cloudflare"; host="cloudflare-dns.com" },
  @{ name="Google";     host="dns.google" },
  @{ name="Quad9";      host="dns.quad9.net" }
)

$all = @()

foreach($p in $providers){
  $ips = @()

  try {
    $a = Resolve-DnsName $p.host -Type A -ErrorAction Stop | Where-Object { $_.IPAddress }
    $ips += $a.IPAddress
  } catch {}

  try {
    $aaaa = Resolve-DnsName $p.host -Type AAAA -ErrorAction Stop | Where-Object { $_.IPAddress }
    $ips += $aaaa.IPAddress
  } catch {}

  $ips = $ips | Sort-Object -Unique
  $all += [pscustomobject]@{ name=$p.name; host=$p.host; ips=$ips }
}

$obj = [pscustomobject]@{
  updated_utc = (Get-Date).ToUniversalTime().ToString("o")
  providers   = $all
}

($obj | ConvertTo-Json -Depth 6) | Set-Content -LiteralPath $out -Encoding UTF8
Write-Host "Wrote: $out"
