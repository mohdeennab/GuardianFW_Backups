$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

# GFW_ROOT_FALLBACK
if(-not (Get-Variable -Name root -Scope Script -ErrorAction SilentlyContinue)){ $script:root = "C:\ProgramData\GuardianFW" }
if([string]::IsNullOrWhiteSpace($script:root)){ $script:root = "C:\ProgramData\GuardianFW" }
$root = $script:root

$logDir = Join-Path $root "logs"
New-Item -ItemType Directory -Path $logDir -Force | Out-Null
$trace  = Join-Path $logDir "health-trace.txt"
$lock   = Join-Path $logDir "health.lock"

function Trace([string]$msg){
  ("[{0}] {1}" -f (Get-Date -Format s), $msg) | Add-Content -Encoding UTF8 $trace
}

# ---- single instance lock ----
try { Remove-Item -LiteralPath $lock -Force -EA SilentlyContinue } catch {}
if(Test-Path $lock){
  Trace "LOCKED: previous run still active; exiting."
  exit 0
}
"locked 2025-12-27T22:43:01 pid=13548" | Set-Content -Encoding UTF8 $lock

try {
  Trace "HEALTH_START"

  # --- run probes ---
  $fw  = & "$root\engine\verify-firewall.ps1"
  $reg = & "$root\engine\verify-registry.ps1"

  # Important: make sure verify-integrity sees the current mode
  $mode = $env:GFW_MODE
  if([string]::IsNullOrWhiteSpace($mode)){ $mode = "PROD" }
  $mode = $mode.ToUpperInvariant()
  if($mode -ne "DEV" -and $mode -ne "PROD"){ $mode = "PROD" }

  $cmd = ("& { $env:GFW_MODE='{0}'; & '{1}\engine\verify-integrity.ps1' | ConvertTo-Json -Depth 10 }" -f $mode, $root)
  $viJson = powershell.exe -NoProfile -ExecutionPolicy Bypass -Command $cmd
  $vi = $viJson | ConvertFrom-Json

  # --- status strings ---
  $firewallStatus = if($null -ne $fw  -and $fw.PSObject.Properties.Name -contains "status"){ [string]$fw.status } else { "ERR" }
  $registryStatus = if($null -ne $reg -and $reg.PSObject.Properties.Name -contains "status"){ [string]$reg.status } else { "ERR" }

  # --- integrity message (DEV can be OK(warnings=N)) ---
  $viStatus = ""
  if($null -ne $vi -and $vi.PSObject.Properties.Name -contains "status"){ $viStatus = [string]$vi.status }

  $warnCount = 0
  if($null -ne $vi -and $vi.PSObject.Properties.Name -contains "warnings"){ $warnCount = @($vi.warnings).Count }

  if($viStatus -eq "OK"){
    if($warnCount -gt 0){ $integrityMsg = "OK(warnings=$warnCount)" } else { $integrityMsg = "OK" }
  } else {
    $integrityMsg = "DRIFT"
  }

  # --- overall ---
  $overall = if($firewallStatus -eq "OK" -and $registryStatus -eq "OK" -and $integrityMsg -like "OK*"){"OK"}else{"DRIFT"}

  # --- print single line (what Task Scheduler should capture) ---
  Write-Host ("HEALTH: {0}  (firewall={1}, registry={2}, integrity={3})" -f $overall, $firewallStatus, $registryStatus, $integrityMsg)

  # --- evidence output ---
  $evDir = Join-Path $root "evidence\health"
  New-Item -ItemType Directory -Path $evDir -Force | Out-Null

  $out = [ordered]@{
    timestamp = (Get-Date).ToString("s")
    mode      = $mode
    overall   = $overall
    firewall  = $fw
    registry  = $reg
    integrity = $vi
  }

  # ---- DECISION_SNAPSHOT_BEGIN (best-effort; recent only) ----
  try {
    $decDir = Join-Path $root "evidence\decisions"
    if(Test-Path $decDir){
      $lastDec = Get-ChildItem $decDir -Filter "decision-*.json" -ErrorAction SilentlyContinue |
        Sort-Object LastWriteTime -Descending | Select-Object -First 1
      if($lastDec){
        $dj = Get-Content $lastDec.FullName -Raw -Encoding UTF8 -ErrorAction SilentlyContinue | ConvertFrom-Json
        $recent = $false
        try {
          if($dj.timestamp){
            $dt = [datetime]::Parse([string]$dj.timestamp)
            if($dt -ge (Get-Date).AddMinutes(-10)) { $recent = $true }
          }
        } catch { $recent = $false }

        if($recent){
          $out.decision = [ordered]@{
            status      = "RECENT"
            file        = $lastDec.Name
            timestamp   = $dj.timestamp
            intent_id   = $dj.intent_id
            decision_id = $dj.decision_id
            out_file    = $dj.out_file
            out_path    = $dj.out_path
          }
        } else {
          $out.decision = [ordered]@{
            status    = "OLD"
            file      = $lastDec.Name
            timestamp = $dj.timestamp
            note      = "newest decision older than 10 minutes"
          }
        }
      } else {
        $out.decision = @{ status="NONE"; note="no decision files found" }
      }
    } else {
      $out.decision = @{ status="MISSING_DIR"; note="evidence\decisions missing" }
    }
  } catch {
    $out.decision = @{ status="ERROR"; error=$_.Exception.Message }
  }
  # ---- DECISION_SNAPSHOT_END ----

  $fn = "health-{0}.json" -f (Get-Date -Format yyyyMMdd-HHmmss)
  $out | ConvertTo-Json -Depth 12 | Out-File (Join-Path $evDir $fn) -Encoding UTF8
  $out | ConvertTo-Json -Depth 12 | Out-File (Join-Path $evDir "health-latest.json") -Encoding UTF8

  Trace ("HEALTH_END overall={0} wrote={1}" -f $overall, $fn)

  # Exit code contract: OK=0, else=20
  exit (if($overall -eq "OK"){0}else{20})

} catch {
  try {
    Trace ("HEALTH_ERROR: {0}" -f $_.Exception.Message)
    Trace ("AT: {0}" -f $_.InvocationInfo.PositionMessage)
  } catch {}

  # Always print something visible
  Write-Host ("HEALTH: DRIFT  (firewall=ERR, registry=ERR, integrity=ERR)")
  Write-Host ("[ERROR] " + $_.Exception.Message)

  exit 20
} finally {
  try { Remove-Item -LiteralPath $lock -Force -EA SilentlyContinue } catch {}
}
