# run-health-phase1.ps1
# GuardianFW – Phase 1 Health Wrapper (CLEAN)

$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

# ---- Task trace ----
try {
  $ts = Get-Date -Format "yyyy-MM-dd HH:mm:ss.fff"
  Write-Host "[TASKTRACE] entered run-health-phase1.ps1 at $ts; user=$([Security.Principal.WindowsIdentity]::GetCurrent().Name)"
} catch {}

# ---- Mutex: prevent overlapping runs ----
$mutexName = "Local\GuardianFW_Health_Lock"
$mutex = $null
$hasLock = $false

try {
  try {
    $mutex = New-Object System.Threading.Mutex($false, $mutexName)
  } catch {
    $mutex = $null
  }

  if ($null -ne $mutex) {
    $hasLock = $mutex.WaitOne(5000)
  } else {
    $hasLock = $true
  }

  if (-not $hasLock) {
    Write-Host "[GFW] Health already running — NOOP"
    exit 0
  }

  # ---- Call inner health (authoritative) ----
  $inner = "C:\ProgramData\GuardianFW\engine\run-health.ps1"
  & powershell.exe -NoProfile -ExecutionPolicy Bypass -File $inner
  exit $LASTEXITCODE

}
catch {
  Write-Host "[GFW] Phase1 exception: $($_.Exception.Message)"
  exit 1
}
finally {
  if ($hasLock -and $null -ne $mutex) {
    try { $mutex.ReleaseMutex() } catch {}
  }
  if ($null -ne $mutex) {
    try { $mutex.Dispose() } catch {}
  }
}

